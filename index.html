import React, { useState, useEffect, useRef } from 'react';
import { RotateCcw, Users, Trophy, ArrowRightLeft, Undo2, Settings } from 'lucide-react';
const TakrawApp = () = {
  --- åˆå§‹è¨­å®šèˆ‡ç‹€æ…‹ ---
  é è¨­çƒå“¡è™Ÿç¢¼
 const initialTeamA = {
   name è‡ªå·±,
   players [1, 2, 3],  [0]å¾Œä¸­(ç™¼çƒ), [1]å·¦å‰, [2]å³å‰
   bench [4, 5, 6],
   color bg-blue-600,
   score 0,
   sets 0
 };
 const initialTeamB = {
   name å°æ‰‹,
   players [11, 12, 13],
   bench [14, 15, 16],
   color bg-red-600,
   score 0,
   sets 0
 };
  éŠæˆ²ç‹€æ…‹
 const [teamA, setTeamA] = useState(initialTeamA);
 const [teamB, setTeamB] = useState(initialTeamB);
 const [servingTeam, setServingTeam] = useState('A');  'A' or 'B'
 const [currentSet, setCurrentSet] = useState(1);
 const [gameHistory, setGameHistory] = useState([]);  ç”¨æ–¼ Undo
 const [matchOver, setMatchOver] = useState(false);
 const [isSwapped, setIsSwapped] = useState(false);  ç¬¬ä¸‰å±€æ›å ´ç‹€æ…‹
 const [showSubModal, setShowSubModal] = useState(false);
 const [subTeam, setSubTeam] = useState('A');  ç•¶å‰æ­£åœ¨æ›äººçš„éšŠä¼
  --- æ ¸å¿ƒé‚è¼¯ ---
  å„²å­˜æ­·å²ç´€éŒ„ (Snapshot)
 const saveState = () = {
   const currentState = {
     teamA JSON.parse(JSON.stringify(teamA)),
     teamB JSON.parse(JSON.stringify(teamB)),
     servingTeam,
     currentSet,
     matchOver,
     isSwapped
   };
    é™åˆ¶æ­·å²ç´€éŒ„é•·åº¦ï¼Œé¿å…è¨˜æ†¶é«”å•é¡Œ
   setGameHistory(prev = [...prev.slice(-20), currentState]);
 };
  å¾©åŸ (Undo)
 const undo = () = {
   if (gameHistory.length === 0) return;
   const lastState = gameHistory[gameHistory.length - 1];
   setTeamA(lastState.teamA);
   setTeamB(lastState.teamB);
   setServingTeam(lastState.servingTeam);
   setCurrentSet(lastState.currentSet);
   setMatchOver(lastState.matchOver);
   setIsSwapped(lastState.isSwapped);
   setGameHistory(prev = prev.slice(0, -1));
 };
  é †æ™‚é‡è¼ªè½‰é‚è¼¯
 const rotatePlayers = (players) = {
   const newPositions = [...players];
   const back = players[0];
   const left = players[1];
   const right = players[2];
   return [right, back, left];
 };
  å¾—åˆ†è™•ç†
 const handleScore = (winner) = {
   if (matchOver) return;
   saveState();
   const isTeamA = winner === 'A';
   const scoringTeam = isTeamA  teamA  teamB;
   const losingTeam = isTeamA  teamB  teamA;
   const setScoringTeam = isTeamA  setTeamA  setTeamB;
    1. å¢åŠ åˆ†æ•¸
   const newScore = scoringTeam.score + 1;
    2. åˆ¤æ–·æ˜¯å¦éœ€è¦è¼ªè½‰
   let shouldRotate = false;
   let nextServingTeam = winner;  è´çƒè€…ç™¼çƒ (åŸºæœ¬è¦å‰‡)
    åˆ¤æ–· Deuce ç‹€æ…‹ (20-20å¹³æ‰‹å¾Œ)
   const isDeuce = (teamA.score = 20 && teamB.score = 20);
   if (isDeuce) {
     if (servingTeam === 'A') nextServingTeam = 'B';
     else nextServingTeam = 'A';
     if (nextServingTeam !== servingTeam) {
       shouldRotate = true;
     }
   } else {
      æ­£å¸¸éšæ®µï¼šè´çƒè€…ç™¼çƒ
     if (servingTeam !== winner) {
       shouldRotate = true;  å¥ªå›ç™¼çƒæ¬Šï¼Œè½‰ä½
     }
   }
    3. æ›´æ–°çƒå“¡ä½ç½® (å¦‚æœéœ€è¦)
   let newPlayers = [...scoringTeam.players];
   if (shouldRotate && nextServingTeam === winner) {
      newPlayers = rotatePlayers(scoringTeam.players);
   }
   let updatedTeamA_Players = [...teamA.players];
   let updatedTeamB_Players = [...teamB.players];
   if (nextServingTeam !== servingTeam) {
     if (nextServingTeam === 'A') {
       updatedTeamA_Players = rotatePlayers(teamA.players);
     } else {
       updatedTeamB_Players = rotatePlayers(teamB.players);
     }
   }
    4. æª¢æŸ¥æ˜¯å¦æ‹¿ä¸‹æ­¤å±€
   const enemyScore = losingTeam.score;
   let setWon = false;
    è¦å‰‡ï¼šè‡³å°‘21åˆ†ï¼Œä¸”è´2åˆ†
   if (newScore = 21 && (newScore - enemyScore) = 2) {
     setWon = true;
   }
    æ›´æ–°ç‹€æ…‹
   if (setWon) {
      handleSetWin(winner, updatedTeamA_Players, updatedTeamB_Players);
   } else {
      setTeamA(prev = ({ ...prev, players updatedTeamA_Players, score isTeamA  newScore  prev.score }));
      setTeamB(prev = ({ ...prev, players updatedTeamB_Players, score !isTeamA  newScore  prev.score }));
      setServingTeam(nextServingTeam);
       æª¢æŸ¥ç¬¬ä¸‰å±€æ›å ´ (ä¿®æ”¹ç‚º 10 åˆ†)
      if (currentSet === 3 && (newScore === 10  enemyScore === 10) && !isSwapped) {
          const maxScore = Math.max(newScore, enemyScore);
          if (maxScore === 10) {
            alert(ç¬¬ä¸‰å±€ 10åˆ†ï¼è«‹äº¤æ›å ´åœ°ã€‚);
            setIsSwapped(true);
          }
      }
   }
 };
 const handleSetWin = (winner, lastPosA, lastPosB) = {
   const isTeamA = winner === 'A';
    å¢åŠ å±€æ•¸
   const newSetsA = teamA.sets + (isTeamA  1  0);
   const newSetsB = teamB.sets + (!isTeamA  1  0);
    æª¢æŸ¥æ¯”è³½æ˜¯å¦çµæŸ
   if (newSetsA === 2  newSetsB === 2) {
      setTeamA(prev = ({ ...prev, score isTeamA  21  prev.score, sets newSetsA }));
      setTeamB(prev = ({ ...prev, score !isTeamA  21  prev.score, sets newSetsB }));
      setMatchOver(true);
      return;
   }
    ä¸‹ä¸€å±€é‡ç½®
   setCurrentSet(prev = prev + 1);
   setTeamA(prev = ({ ...prev, score 0, sets newSetsA, players lastPosA }));
   setTeamB(prev = ({ ...prev, score 0, sets newSetsB, players lastPosB }));
   setServingTeam(winner);
   alert(`ç¬¬ ${currentSet} å±€çµæŸï¼Œç”± ${winner === 'A'  teamA.name  teamB.name} ç²å‹ï¼`);
 };
  æ›äººé‚è¼¯
 const handleSubstitution = (playerOut, playerIn) = {
   saveState();
   const targetSetTeam = subTeam === 'A'  setTeamA  setTeamB;
   targetSetTeam(prev = {
     const newPlayers = prev.players.map(p = p === playerOut  playerIn  p);
     const newBench = prev.bench.map(p = p === playerIn  playerOut  p);
     return { ...prev, players newPlayers, bench newBench };
   });
   setShowSubModal(false);
 };
  --- UI å…ƒä»¶ ---
 const PlayerNode = ({ number, position, teamColor, isServing }) = {
   const posLabel = [å¾Œä¸­, å·¦å‰, å³å‰];
   return (
div className={`relative flex flex-col items-center justify-center w-20 h-20 mdw-24 mdh-24 rounded-full border-4 shadow-lg transition-all duration-500
       ${teamColor} ${isServing  'border-yellow-400 ring-4 ring-yellow-200 scale-110'  'border-white'} text-white font-bold text-2xl mdtext-3xl`}

       {number}
span className=absolute -bottom-6 text-xs mdtext-sm bg-gray-800 text-white px-2 py-0.5 rounded opacity-80 whitespace-nowrap
         {posLabel[position]}
span
       {isServing && (
span className=absolute -top-3 -right-2 bg-yellow-500 text-black text-xs font-bold px-2 py-1 rounded-full animate-bounce
           ç™¼çƒ
span
       )}
div
   );
 };
  åŠå ´ç¹ªè£½
 const HalfCourt = ({ team, isTop, isServingTeam }) = {
   const p = team.players;
   return (
div className={`relative flex-1 w-full bg-emerald-600 border-2 border-white50 p-4 flex flex-col justify-between overflow-hidden ${isTop  'border-b-4 border-b-white80'  'border-t-4 border-t-white80'}`}
       { èƒŒæ™¯è£é£¾ç·š }
div className=absolute inset-0 opacity-10 pointer-events-none
div className=w-full h-full border-x-[40px] border-emerald-80030div
div className=absolute top-12 left-12 -translate-x-12 -translate-y-12 w-32 h-32 rounded-full border-4 border-whitediv
div
       { ä¸ŠåŠå ´ (é ç«¯) }
       {isTop  (

            { Back Player (æœ€é ) }
div className=flex justify-center pt-4
PlayerNode number={p[0]} position={0} teamColor={team.color} isServing={isServingTeam} 
div
            { Front Players (è¿‘ç¶²) }
div className=flex justify-around pb-8 items-end flex-1
PlayerNode number={p[2]} position={2} teamColor={team.color} isServing={false}  { è¦–è¦ºå³å‰ }
PlayerNode number={p[1]} position={1} teamColor={team.color} isServing={false}  { è¦–è¦ºå·¦å‰ }
div

       )  (
          ä¸‹åŠå ´ (è¿‘ç«¯) 

            { Front Players (è¿‘ç¶²) }
div className=flex justify-around pt-8 items-start flex-1
PlayerNode number={p[1]} position={1} teamColor={team.color} isServing={false} 
PlayerNode number={p[2]} position={2} teamColor={team.color} isServing={false} 
div
            { Back Player (æœ€é ) }
div className=flex justify-center pb-4
PlayerNode number={p[0]} position={0} teamColor={team.color} isServing={isServingTeam} 
div

       )}
       { éšŠä¼åç¨± }
div className={`absolute ${isTop  'top-2 left-2'  'bottom-2 right-2'} bg-black40 text-white px-3 py-1 rounded backdrop-blur-sm`}
         {team.name} {isServingTeam && ğŸ¾}
div
div
   );
 };
  æ›äººå½ˆçª—
 const SubstitutionModal = () = {
   if (!showSubModal) return null;
   const targetTeam = subTeam === 'A'  teamA  teamB;
   return (
div className=fixed inset-0 bg-black70 z-50 flex items-center justify-center p-4
div className=bg-white rounded-xl w-full max-w-md overflow-hidden shadow-2xl
div className=bg-gray-800 text-white p-4 flex justify-between items-center
h3 className=text-xl font-bold flex items-center gap-2
ArrowRightLeft size={20} {targetTeam.name} æ›äºº
h3
button onClick={() = setShowSubModal(false)} className=text-gray-400 hovertext-whiteâœ•button
div
div className=p-4
p className=text-sm text-gray-500 mb-2é»æ“Šå ´ä¸Šçƒå“¡ä»¥æ›ä¸‹ï¼šp
div className=grid grid-cols-3 gap-2 mb-6
             {targetTeam.players.map((pNum, idx) = (
button
                 key={pNum}
                 className={`p-3 rounded-lg border-2 text-center hoverbg-red-50 border-red-200`}
                 onClick={() = {
                     ç°¡å–®èµ·è¦‹ï¼Œé€™è£¡åšå…©éšæ®µï¼šå…ˆé¸å ´ä¸Šï¼Œå†é¸å ´ä¸‹ã€‚
                     ç‚ºäº† UI ç°¡æ½”ï¼Œæˆ‘å€‘ç›´æ¥åˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„æ›¿æ›çµ„åˆ
                 }}

div className=text-xl font-bold text-gray-800{pNum}div
button
             ))}
div
p className=text-sm text-gray-500 mb-2åŸ·è¡Œæ›äºº (å°‡æ¿å‡³çƒå“¡æ›å…¥å ´ä¸ŠæŸä½ç½®)ï¼šp
div className=space-y-2 max-h-60 overflow-y-auto
             {targetTeam.bench.map(benchPlayer = (
div key={benchPlayer} className=flex gap-2 items-center bg-gray-50 p-2 rounded
div className=w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center font-bold text-gray-700
                   {benchPlayer}
div
div className=flex-1 grid grid-cols-3 gap-1
                   {targetTeam.players.map((activePlayer, idx) = (
button
                       key={idx}
                       onClick={() = handleSubstitution(activePlayer, benchPlayer)}
                       className=bg-blue-100 hoverbg-blue-600 hovertext-white text-blue-800 text-xs py-1 px-2 rounded transition-colors

                       æ›ä¸‹ {activePlayer}
button
                   ))}
div
div
             ))}
div
div
div
div
   );
 };
  æ±ºå®šä¸Šä¸‹åŠå ´é¡¯ç¤ºèª°
  æ­£å¸¸ Top=B, Bottom=A
  Swapped Top=A, Bottom=B
 const topTeam = isSwapped  teamA  teamB;
 const bottomTeam = isSwapped  teamB  teamA;
 const isTopServing = servingTeam === (isSwapped  'A'  'B');
 const isBottomServing = servingTeam === (isSwapped  'B'  'A');
 return (
div className=h-screen w-full bg-gray-900 flex flex-col mdflex-row overflow-hidden font-sans
     { å·¦å´ä¸Šæ–¹ï¼šæ¯”åˆ†æ¿èˆ‡æ§åˆ¶ }
div className=w-full mdw-13 bg-gray-800 text-white flex flex-col border-r border-gray-700 shadow-xl z-10
       { é ‚éƒ¨è³‡è¨Š }
div className=p-4 border-b border-gray-700 flex justify-between items-center bg-gray-900
div className=text-sm text-gray-400Set {currentSet}div
h1 className=text-xl font-bold text-yellow-500 flex items-center gap-2
Trophy size={18} è¶³æ¯½è¨ˆåˆ†æ¿
h1
button onClick={undo} className=p-2 bg-gray-700 rounded hoverbg-gray-600 disabledopacity-30 disabled={gameHistory.length === 0}
Undo2 size={18} 
button
div
       { æ¯”åˆ†é¡¯ç¤ºå€åŸŸ - ä¿®æ”¹ç‚ºå·¦å³ä¸¦æ’ (flex-row) }
div className=flex-1 flex flex-row items-stretch justify-center p-2 gap-2
         { A éšŠ (è‡ªå·±) åˆ†æ•¸å¡ }
div
           onClick={() = handleScore('A')}
           className={`flex-1 rounded-xl p-2 flex flex-col items-center justify-center cursor-pointer transition-all activescale-95
             ${teamA.color} bg-opacity-90 hoverbg-opacity-100 border-4 ${servingTeam === 'A'  'border-yellow-400'  'border-transparent'}`}

div className=text-center mb-2
div className=text-xl mdtext-2xl font-bold opacity-90{teamA.name}div
div className=text-xs bg-black20 inline-block px-2 py-0.5 rounded mt-1å±€æ•¸ {teamA.sets}div
div
div className=text-6xl mdtext-8xl font-bold font-mono{teamA.score}div
div
         { B éšŠ (å°æ‰‹) åˆ†æ•¸å¡ }
div
           onClick={() = handleScore('B')}
           className={`flex-1 rounded-xl p-2 flex flex-col items-center justify-center cursor-pointer transition-all activescale-95
             ${teamB.color} bg-opacity-90 hoverbg-opacity-100 border-4 ${servingTeam === 'B'  'border-yellow-400'  'border-transparent'}`}

div className=text-center mb-2
div className=text-xl mdtext-2xl font-bold opacity-90{teamB.name}div
div className=text-xs bg-black20 inline-block px-2 py-0.5 rounded mt-1å±€æ•¸ {teamB.sets}div
div
div className=text-6xl mdtext-8xl font-bold font-mono{teamB.score}div
div
div
       { åº•éƒ¨æ§åˆ¶åˆ— }
div className=p-4 bg-gray-900 border-t border-gray-700 grid grid-cols-2 gap-3
button
            onClick={() = { setSubTeam('A'); setShowSubModal(true); }}
            className=flex items-center justify-center gap-2 bg-blue-900 text-blue-200 py-3 rounded-lg hoverbg-blue-800

Users size={18} è‡ªå·±æ›äºº
button
button
            onClick={() = { setSubTeam('B'); setShowSubModal(true); }}
            className=flex items-center justify-center gap-2 bg-red-900 text-red-200 py-3 rounded-lg hoverbg-red-800

Users size={18} å°æ‰‹æ›äºº
button
button
             onClick={() = {
               if(window.confirm(ç¢ºå®šè¦äº¤æ›å ´åœ°å—ï¼Ÿ(é€šå¸¸ç³»çµ±æœƒè‡ªå‹•æç¤º))) setIsSwapped(!isSwapped);
             }}
             className=col-span-2 text-sm text-gray-500 hovertext-white py-2 flex items-center justify-center gap-1

RotateCcw size={14}  æ‰‹å‹•äº¤æ›å ´åœ°
button
div
div
     { å³å´ä¸‹æ–¹ï¼šçƒå ´æ¨¡æ“¬ }
div className=flex-1 relative flex flex-col h-[60vh] mdh-full bg-emerald-900
       {matchOver && (
div className=absolute inset-0 z-20 bg-black80 flex flex-col items-center justify-center text-white p-8 text-center backdrop-blur-sm
Trophy size={64} className=text-yellow-400 mb-4 animate-bounce
h2 className=text-4xl font-bold mb-2æ¯”è³½çµæŸ!h2
p className=text-2xl mb-8
              ç²å‹è€… span className=text-yellow-400{teamA.sets  teamB.sets  teamA.name  teamB.name}span
p
button
             onClick={() = window.location.reload()}
             className=bg-white text-black px-6 py-3 rounded-full font-bold hoverbg-gray-200 transition-colors

             é–‹å§‹æ–°æ¯”è³½
button
div
       )}
       { ç¶²å­ (çµ•å°å®šä½åœ¨ä¸­é–“) }
div className=absolute top-12 left-0 w-full h-1 bg-white50 z-10 flex items-center justify-center
div className=bg-white80 px-4 py-1 rounded-full text-black text-xs font-bold shadow-smNET (ç¶²)div
div
       { çƒå ´å€åŸŸ }
div className=flex-1 flex flex-col w-full h-full max-w-2xl mx-auto shadow-2xl
HalfCourt team={topTeam} isTop={true} isServingTeam={isTopServing} 
HalfCourt team={bottomTeam} isTop={false} isServingTeam={isBottomServing} 
div
div
     { Modals }
SubstitutionModal 
div
 );
};
export default TakrawApp;

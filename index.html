import React, { useState } from 'react';
import { RotateCcw, Users, Trophy, ArrowRightLeft, Undo2, Play, ChevronRight } from 'lucide-react';

// --- ç¨ç«‹å…ƒä»¶ (ç§»è‡³å¤–éƒ¨ä»¥é¿å…é‡æ–°æ¸²æŸ“å•é¡Œ) ---

const PlayerNode = ({ number, position, teamColor, isServing }) => {
  const posLabel = ["å¾Œä¸­", "å·¦å‰", "å³å‰"];
  
  return (
    <div 
      className={`relative flex flex-col items-center justify-center w-20 h-20 md:w-24 md:h-24 rounded-full border-4 shadow-lg transition-all duration-300
      ${teamColor} ${isServing ? 'border-yellow-400 ring-4 ring-yellow-200 scale-110' : 'border-white'} text-white font-bold text-2xl md:text-3xl`}
    >
      {number}
      <span className="absolute -bottom-6 text-xs md:text-sm bg-gray-800 text-white px-2 py-0.5 rounded opacity-80 whitespace-nowrap">
        {posLabel[position]}
      </span>
      {isServing && (
        <span className="absolute -top-3 -right-2 bg-yellow-500 text-black text-xs font-bold px-2 py-1 rounded-full animate-bounce">
          ç™¼çƒ
        </span>
      )}
    </div>
  );
};

const TakrawApp = () => {
  // --- éŠæˆ²ç‹€æ…‹ ---
  const [teamA, setTeamA] = useState(null);
  const [teamB, setTeamB] = useState(null);
  
  const [servingTeam, setServingTeam] = useState('A');
  const [firstServerOfMatch, setFirstServerOfMatch] = useState('A');
  const [currentSet, setCurrentSet] = useState(1);
  const [gameHistory, setGameHistory] = useState([]);
  const [matchOver, setMatchOver] = useState(false);
  const [isSwapped, setIsSwapped] = useState(false);
  const [showSubModal, setShowSubModal] = useState(false);
  const [subTeam, setSubTeam] = useState('A');
  const [swapMessage, setSwapMessage] = useState(null);
  const [matchStarted, setMatchStarted] = useState(false);

  // --- é–‹å§‹ç•«é¢ç‹€æ…‹ ---
  const [setupStep, setSetupStep] = useState(1);
  const [teamAInput, setTeamAInput] = useState('1, 2, 3, 4, 5, 6');
  const [teamBInput, setTeamBInput] = useState('11, 12, 13, 14, 15, 16');
  const [setupError, setSetupError] = useState(null);
  const [selectedFirstServer, setSelectedFirstServer] = useState(null);

  // --- æ ¸å¿ƒé‚è¼¯ ---
  const saveState = () => {
    const currentState = {
      teamA: JSON.parse(JSON.stringify(teamA)),
      teamB: JSON.parse(JSON.stringify(teamB)),
      servingTeam,
      currentSet,
      matchOver,
      isSwapped
    };
    setGameHistory(prev => [...prev.slice(-20), currentState]);
  };

  const undo = () => {
    if (gameHistory.length === 0) return;
    const lastState = gameHistory[gameHistory.length - 1];
    setTeamA(lastState.teamA);
    setTeamB(lastState.teamB);
    setServingTeam(lastState.servingTeam);
    setCurrentSet(lastState.currentSet);
    setMatchOver(lastState.matchOver);
    setIsSwapped(lastState.isSwapped);
    setGameHistory(prev => prev.slice(0, -1));
  };

  const rotatePlayers = (players) => {
    const back = players[0];
    const left = players[1];
    const right = players[2];
    return [right, back, left]; 
  };

  const showSwapAlert = (message) => {
    setSwapMessage(message);
    setTimeout(() => setSwapMessage(null), 3000);
  };

  const parsePlayerInput = (input) => {
    return input
      .split(/[,ï¼Œ\s]+/)
      .map(s => s.trim())
      .filter(s => s !== '')
      .map(s => parseInt(s, 10))
      .filter(n => !isNaN(n) && n >= 0);
  };

  const validateAndProceed = () => {
    setSetupError(null);
    
    const teamANumbers = parsePlayerInput(teamAInput);
    const teamBNumbers = parsePlayerInput(teamBInput);

    if (teamANumbers.length < 3) {
      setSetupError("ã€Œè‡ªå·±ã€éšŠä¼è‡³å°‘éœ€è¦ 3 ä½çƒå“¡");
      return;
    }
    if (teamANumbers.length > 6) {
      setSetupError("ã€Œè‡ªå·±ã€éšŠä¼æœ€å¤š 6 ä½çƒå“¡");
      return;
    }
    if (teamBNumbers.length < 3) {
      setSetupError("ã€Œå°æ‰‹ã€éšŠä¼è‡³å°‘éœ€è¦ 3 ä½çƒå“¡");
      return;
    }
    if (teamBNumbers.length > 6) {
      setSetupError("ã€Œå°æ‰‹ã€éšŠä¼æœ€å¤š 6 ä½çƒå“¡");
      return;
    }

    if (new Set(teamANumbers).size !== teamANumbers.length) {
      setSetupError("ã€Œè‡ªå·±ã€éšŠä¼çš„çƒå“¡è™Ÿç¢¼ä¸èƒ½é‡è¤‡");
      return;
    }
    if (new Set(teamBNumbers).size !== teamBNumbers.length) {
      setSetupError("ã€Œå°æ‰‹ã€éšŠä¼çš„çƒå“¡è™Ÿç¢¼ä¸èƒ½é‡è¤‡");
      return;
    }

    setSetupStep(2);
  };

  const startMatch = () => {
    if (!selectedFirstServer) {
      setSetupError("è«‹é¸æ“‡å“ªéšŠå…ˆç™¼çƒ");
      return;
    }

    const teamANumbers = parsePlayerInput(teamAInput);
    const teamBNumbers = parsePlayerInput(teamBInput);

    const newTeamA = {
      name: "è‡ªå·±",
      players: teamANumbers.slice(0, 3),
      bench: teamANumbers.slice(3),
      color: "bg-blue-600",
      score: 0,
      sets: 0
    };

    const newTeamB = {
      name: "å°æ‰‹",
      players: teamBNumbers.slice(0, 3),
      bench: teamBNumbers.slice(3),
      color: "bg-red-600",
      score: 0,
      sets: 0
    };

    setTeamA(newTeamA);
    setTeamB(newTeamB);
    setServingTeam(selectedFirstServer);
    setFirstServerOfMatch(selectedFirstServer);
    setMatchStarted(true);
  };

  const handleScore = (winner) => {
    if (matchOver || !matchStarted) return;
    saveState();

    const isTeamA = winner === 'A';
    const scoringTeam = isTeamA ? teamA : teamB;
    const losingTeam = isTeamA ? teamB : teamA;
    
    const newScore = scoringTeam.score + 1;
    const enemyScore = losingTeam.score;

    const newScoreA = isTeamA ? newScore : teamA.score;
    const newScoreB = !isTeamA ? newScore : teamB.score;

    const isInDeuce = newScoreA >= 20 && newScoreB >= 20;
    
    let nextServingTeam;
    if (isInDeuce) {
      nextServingTeam = servingTeam === 'A' ? 'B' : 'A';
    } else {
      nextServingTeam = winner;
    }

    let updatedTeamA_Players = [...teamA.players];
    let updatedTeamB_Players = [...teamB.players];

    if (nextServingTeam !== servingTeam) {
      if (nextServingTeam === 'A') {
        updatedTeamA_Players = rotatePlayers(teamA.players);
      } else {
        updatedTeamB_Players = rotatePlayers(teamB.players);
      }
    }

    // Check for Set Win: >= 21 and (Diff >= 2) OR (Score = 25)
    let setWon = false;
    if (newScore >= 21 && (newScore - enemyScore) >= 2) {
      setWon = true;
    } else if (newScore === 25) {
      setWon = true; // Set max score is 25
    }

    if (setWon) {
       handleSetWin(winner, updatedTeamA_Players, updatedTeamB_Players, newScore, enemyScore);
    } else {
       setTeamA(prev => ({ ...prev, players: updatedTeamA_Players, score: newScoreA }));
       setTeamB(prev => ({ ...prev, players: updatedTeamB_Players, score: newScoreB }));
       setServingTeam(nextServingTeam);
       
       if (currentSet === 3 && !isSwapped && (newScoreA === 10 || newScoreB === 10)) {
         setIsSwapped(true);
         showSwapAlert("ğŸ”„ ç¬¬ä¸‰å±€é” 10 åˆ†ï¼è‡ªå‹•äº¤æ›å ´åœ°ï¼");
       }
    }
  };
  
  const handleSetWin = (winner, lastPosA, lastPosB, finalScore, finalEnemyScore) => {
    const isTeamA = winner === 'A';
    
    const newSetsA = teamA.sets + (isTeamA ? 1 : 0);
    const newSetsB = teamB.sets + (!isTeamA ? 1 : 0);

    // Update final score for the set
    const finalScoreA = isTeamA ? finalScore : finalEnemyScore;
    const finalScoreB = !isTeamA ? finalScore : finalEnemyScore;


    if (newSetsA === 2 || newSetsB === 2) {
       setTeamA(prev => ({ ...prev, score: finalScoreA, sets: newSetsA }));
       setTeamB(prev => ({ ...prev, score: finalScoreB, sets: newSetsB }));
       setMatchOver(true);
       showSwapAlert(`ğŸ† æ¯”è³½çµæŸï¼${winner === 'A' ? teamA.name : teamB.name} ç²å‹ï¼`);
       return;
    }

    const nextSet = currentSet + 1;
    setCurrentSet(nextSet);
    
    // Determine next set server (Set 2: loser of Set 1. Set 3: winner of coin toss)
    let nextSetServer;
    if (nextSet === 2) {
      // Set 2: Server is the loser of Set 1
      nextSetServer = winner === 'A' ? 'B' : 'A';
    } else {
      // Set 3: Server is the winner of the coin toss (first server of match)
      nextSetServer = firstServerOfMatch;
    }

    setTeamA(prev => ({ ...prev, score: 0, sets: newSetsA, players: lastPosA }));
    setTeamB(prev => ({ ...prev, score: 0, sets: newSetsB, players: lastPosB }));
    
    setServingTeam(nextSetServer);
    
    setIsSwapped(false);
    
    showSwapAlert(`ğŸ‰ ç¬¬ ${currentSet} å±€çµæŸï¼${winner === 'A' ? teamA.name : teamB.name} ç²å‹ï¼é€²å…¥ç¬¬ ${nextSet} å±€ï¼`);
  };


  const handleSubstitution = (playerOut, playerIn) => {
    saveState();
    const targetSetTeam = subTeam === 'A' ? setTeamA : setTeamB;
    
    targetSetTeam(prev => {
      // Replace playerOut with playerIn in the 'players' array
      const newPlayers = prev.players.map(p => p === playerOut ? playerIn : p);
      
      // Move playerOut to the bench, remove playerIn from the bench
      const newBench = prev.bench.filter(p => p !== playerIn);
      newBench.push(playerOut); 

      return { ...prev, players: newPlayers, bench: newBench };
    });
    setShowSubModal(false);
  };

  const handleManualSwap = () => {
    saveState();
    setIsSwapped(prev => !prev);
    showSwapAlert("ğŸ”„ å·²æ‰‹å‹•äº¤æ›å ´åœ°ï¼");
  };

  // --- UI å­å…ƒä»¶ (ä¿æŒåœ¨å…§éƒ¨ä»¥ä½¿ç”¨ Closure è®Šæ•¸ï¼Œä½† StartScreen å·²æ”¹ç‚ºç›´æ¥æ¸²æŸ“) ---

  const HalfCourt = ({ team, isTop, isServingTeam }) => {
    const p = team.players;

    // ç«™ä½é †åº: [0] = å¾Œä¸­, [1] = å·¦å‰, [2] = å³å‰
    // Top Court: Back (0) is furthest away, Left/Right (1, 2) are closest to net.
    // Bottom Court: Back (0) is closest, Left/Right (1, 2) are furthest.
    // We swap the positions in the array (1 and 2) to maintain Left/Right visual symmetry
    // for the user, regardless of which side they are on.
    // But the rotation logic is based on: [0, 1, 2] -> [2, 0, 1] (Right, Back, Left)

    return (
      <div className={`relative flex-1 w-full bg-emerald-600 border-2 border-white/50 p-4 flex flex-col justify-between overflow-hidden ${isTop ? 'border-b-4 border-b-white/80' : 'border-t-4 border-t-white/80'}`}>
        
        <div className="absolute inset-0 opacity-10 pointer-events-none">
           <div className="w-full h-full border-x-[40px] border-emerald-800/30"></div>
           <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-32 h-32 rounded-full border-4 border-white"></div>
        </div>

        {isTop ? (
          // Top Team (é é›¢è‡ªå·±)
          <>
             <div className="flex justify-center pt-4">
                <PlayerNode number={p[0]} position={0} teamColor={team.color} isServing={isServingTeam && p[0] === team.players[0]} />
             </div>
             <div className="flex justify-around pb-8 items-end flex-1">
                <PlayerNode number={p[2]} position={2} teamColor={team.color} isServing={isServingTeam && p[2] === team.players[0]} />
                <PlayerNode number={p[1]} position={1} teamColor={team.color} isServing={isServingTeam && p[1] === team.players[0]} />
             </div>
          </>
        ) : (
          // Bottom Team (é è¿‘è‡ªå·±)
          <>
             <div className="flex justify-around pt-8 items-start flex-1">
                <PlayerNode number={p[1]} position={1} teamColor={team.color} isServing={isServingTeam && p[1] === team.players[0]} />
                <PlayerNode number={p[2]} position={2} teamColor={team.color} isServing={isServingTeam && p[2] === team.players[0]} />
             </div>
             <div className="flex justify-center pb-4">
                <PlayerNode number={p[0]} position={0} teamColor={team.color} isServing={isServingTeam && p[0] === team.players[0]} />
             </div>
          </>
        )}
        
        <div className={`absolute ${isTop ? 'top-2 left-2' : 'bottom-2 right-2'} bg-black/40 text-white px-3 py-1 rounded backdrop-blur-sm flex items-center gap-2`}>
          <span className={`w-3 h-3 rounded-full ${team.color}`}></span>
          {team.name} {isServingTeam && "ğŸ¾"}
          {isSwapped && <span className="text-xs text-yellow-300">(å·²æ›å ´)</span>}
        </div>
      </div>
    );
  };

  const SubstitutionModal = () => {
    if (!showSubModal) return null;
    const targetTeam = subTeam === 'A' ? teamA : teamB;
    
    if (targetTeam.bench.length === 0) {
      return (
        <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-xl w-full max-w-md overflow-hidden shadow-2xl">
            <div className="bg-gray-800 text-white p-4 flex justify-between items-center">
              <h3 className="text-xl font-bold flex items-center gap-2">
                <ArrowRightLeft size={20}/> {targetTeam.name} æ›äºº
              </h3>
              <button onClick={() => setShowSubModal(false)} className="text-gray-400 hover:text-white text-2xl">âœ•</button>
            </div>
            <div className="p-8 text-center">
              <div className="text-gray-400 text-6xl mb-4">ğŸš«</div>
              <p className="text-gray-600 text-lg">æ²’æœ‰å¾Œå‚™çƒå“¡å¯æ›</p>
              <p className="text-gray-400 text-sm mt-2">è©²éšŠåªæœ‰ 3 ä½çƒå“¡</p>
            </div>
          </div>
        </div>
      );
    }
    
    return (
      <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-xl w-full max-w-md overflow-hidden shadow-2xl">
          <div className="bg-gray-800 text-white p-4 flex justify-between items-center">
            <h3 className="text-xl font-bold flex items-center gap-2">
              <ArrowRightLeft size={20}/> {targetTeam.name} æ›äºº
            </h3>
            <button onClick={() => setShowSubModal(false)} className="text-gray-400 hover:text-white text-2xl">âœ•</button>
          </div>
          
          <div className="p-4">
            <p className="text-sm text-gray-500 mb-4">é¸æ“‡å¾Œå‚™çƒå“¡æ›ä¸‹å ´ä¸Šçƒå“¡ï¼š</p>
            <div className="space-y-2 max-h-64 overflow-y-auto">
              {targetTeam.bench.map((benchPlayer, idx) => (
                <div key={idx} className="flex gap-2 items-center bg-gray-50 p-3 rounded-lg">
                  <div className={`w-12 h-12 ${targetTeam.color} rounded-full flex items-center justify-center font-bold text-white text-lg`}>
                    {benchPlayer}
                  </div>
                  <span className="text-gray-500 mx-2">â†’</span>
                  <div className="flex-1 grid grid-cols-3 gap-2">
                    {targetTeam.players.map((activePlayer, i) => (
                      <button
                        key={i}
                        onClick={() => handleSubstitution(activePlayer, benchPlayer)}
                        className="bg-blue-100 hover:bg-blue-600 hover:text-white text-blue-800 py-2 px-3 rounded-lg transition-colors font-medium"
                      >
                        æ› {activePlayer}
                      </button>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    );
  };

  // --- ä¸»è¦æ¸²æŸ“é‚è¼¯ ---

  if (!matchStarted) {
    // [ä¿®å¾©] å°‡ StartScreen é‚è¼¯ç›´æ¥å¯«åœ¨é€™è£¡ï¼Œè€Œä¸æ˜¯ä½œç‚ºå­å…ƒä»¶
    // é€™æ¨£å¯ä»¥é¿å…è¼¸å…¥æ™‚å› ç‚ºå…ƒä»¶é‡æ–°æ›è¼‰è€Œå°è‡´å¤±å»ç„¦é» (Focus)
    const teamANumbers = parsePlayerInput(teamAInput);
    const teamBNumbers = parsePlayerInput(teamBInput);

    return (
      <div className="fixed inset-0 bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 z-50 flex flex-col items-center justify-center p-4 overflow-y-auto">
        <div className="w-full max-w-lg py-8">
          <div className="text-center mb-8">
            <Trophy size={48} className="text-yellow-500 mx-auto mb-4" />
            <h1 className="text-3xl font-bold text-white mb-2">è¶³æ¯½è¨ˆåˆ†æ¿</h1>
            <p className="text-gray-400">
              {setupStep === 1 ? 'æ­¥é©Ÿ 1/2ï¼šè¼¸å…¥çƒå“¡è™Ÿç¢¼' : 'æ­¥é©Ÿ 2/2ï¼šé¸æ“‡ç™¼çƒæ¬Š'}
            </p>
          </div>

          {setupError && (
            <div className="bg-red-500/20 border border-red-500 text-red-300 px-4 py-3 rounded-lg mb-6 text-center">
              {setupError}
            </div>
          )}

          {setupStep === 1 ? (
            <div className="space-y-6">
              <div className="bg-blue-900/30 border border-blue-500/50 rounded-xl p-5">
                <div className="flex items-center gap-2 mb-3">
                  <div className="w-4 h-4 bg-blue-600 rounded-full"></div>
                  <h2 className="text-xl font-bold text-blue-300">è‡ªå·±</h2>
                  <span className="text-blue-400/60 text-sm ml-auto">
                    å·²è¼¸å…¥ {teamANumbers.length} äºº
                  </span>
                </div>
                <input
                  type="text"
                  value={teamAInput}
                  onChange={(e) => setTeamAInput(e.target.value)}
                  placeholder="ä¾‹å¦‚ï¼š1, 2, 3, 4, 5, 6"
                  className="w-full p-3 bg-gray-800 border border-blue-500/30 rounded-lg text-white text-lg focus:outline-none focus:border-blue-400"
                />
                <p className="text-blue-400/60 text-xs mt-2">
                  è¼¸å…¥ 3-6 å€‹è™Ÿç¢¼ï¼Œç”¨é€—è™Ÿæˆ–ç©ºæ ¼åˆ†éš”ã€‚å‰ 3 ä½ç‚ºå ´ä¸Šçƒå“¡ï¼ˆå¾Œä¸­ã€å·¦å‰ã€å³å‰ï¼‰
                </p>
                {teamANumbers.length >= 3 && (
                  <div className="mt-3 flex flex-wrap gap-2">
                    <span className="text-xs text-gray-500">é è¦½ï¼š</span>
                    {teamANumbers.slice(0, 3).map((n, i) => (
                      <span key={i} className="bg-blue-600 text-white text-sm px-2 py-1 rounded-full">
                        {n} {i === 0 ? '(å¾Œä¸­)' : i === 1 ? '(å·¦å‰)' : '(å³å‰)'}
                      </span>
                    ))}
                    {teamANumbers.slice(3).map((n, i) => (
                      <span key={i + 3} className="bg-blue-600/40 text-blue-200 text-sm px-2 py-1 rounded-full">
                        {n} (å¾Œå‚™)
                      </span>
                    ))}
                  </div>
                )}
              </div>

              <div className="bg-red-900/30 border border-red-500/50 rounded-xl p-5">
                <div className="flex items-center gap-2 mb-3">
                  <div className="w-4 h-4 bg-red-600 rounded-full"></div>
                  <h2 className="text-xl font-bold text-red-300">å°æ‰‹</h2>
                  <span className="text-red-400/60 text-sm ml-auto">
                    å·²è¼¸å…¥ {teamBNumbers.length} äºº
                  </span>
                </div>
                <input
                  type="text"
                  value={teamBInput}
                  onChange={(e) => setTeamBInput(e.target.value)}
                  placeholder="ä¾‹å¦‚ï¼š11, 12, 13, 14, 15, 16"
                  className="w-full p-3 bg-gray-800 border border-red-500/30 rounded-lg text-white text-lg focus:outline-none focus:border-red-400"
                />
                <p className="text-red-400/60 text-xs mt-2">
                  è¼¸å…¥ 3-6 å€‹è™Ÿç¢¼ã€‚å¦‚å°æ–¹åªæœ‰ 5 äººï¼Œè¼¸å…¥ 5 å€‹è™Ÿç¢¼å³å¯
                </p>
                {teamBNumbers.length >= 3 && (
                  <div className="mt-3 flex flex-wrap gap-2">
                    <span className="text-xs text-gray-500">é è¦½ï¼š</span>
                    {teamBNumbers.slice(0, 3).map((n, i) => (
                      <span key={i} className="bg-red-600 text-white text-sm px-2 py-1 rounded-full">
                        {n} {i === 0 ? '(å¾Œä¸­)' : i === 1 ? '(å·¦å‰)' : '(å³å‰)'}
                      </span>
                    ))}
                    {teamBNumbers.slice(3).map((n, i) => (
                      <span key={i + 3} className="bg-red-600/40 text-red-200 text-sm px-2 py-1 rounded-full">
                        {n} (å¾Œå‚™)
                      </span>
                    ))}
                  </div>
                )}
              </div>

              <button
                onClick={validateAndProceed}
                className="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-4 rounded-xl text-lg flex items-center justify-center gap-2 transition-all"
              >
                ä¸‹ä¸€æ­¥ï¼šé¸æ“‡ç™¼çƒæ¬Š <ChevronRight size={20} />
              </button>
            </div>
          ) : (
            <div className="space-y-6">
              <div className="bg-gray-800/50 rounded-xl p-5">
                <h2 className="text-lg font-bold text-gray-300 mb-4 text-center">è«‹é¸æ“‡å“ªéšŠå…ˆç™¼çƒ</h2>
                
                <div className="grid grid-cols-2 gap-4">
                  <button
                    onClick={() => setSelectedFirstServer('A')}
                    className={`p-6 rounded-xl border-4 transition-all ${
                      selectedFirstServer === 'A' 
                        ? 'bg-blue-600 border-yellow-400 scale-105' 
                        : 'bg-blue-600/30 border-blue-600/50 hover:bg-blue-600/50'
                    }`}
                  >
                    <div className="text-white font-bold text-xl mb-2">è‡ªå·±</div>
                    <div className="text-blue-200 text-sm">å…ˆç™¼çƒ</div>
                    {selectedFirstServer === 'A' && (
                      <div className="mt-2 text-yellow-400 text-2xl">âœ“</div>
                    )}
                  </button>

                  <button
                    onClick={() => setSelectedFirstServer('B')}
                    className={`p-6 rounded-xl border-4 transition-all ${
                      selectedFirstServer === 'B' 
                        ? 'bg-red-600 border-yellow-400 scale-105' 
                        : 'bg-red-600/30 border-red-600/50 hover:bg-red-600/50'
                    }`}
                  >
                    <div className="text-white font-bold text-xl mb-2">å°æ‰‹</div>
                    <div className="text-red-200 text-sm">å…ˆç™¼çƒ</div>
                    {selectedFirstServer === 'B' && (
                      <div className="mt-2 text-yellow-400 text-2xl">âœ“</div>
                    )}
                  </button>
                </div>
              </div>

              <div className="bg-gray-800/30 rounded-xl p-4">
                <h3 className="text-sm text-gray-500 mb-3">çƒå“¡åå–®ç¢ºèª</h3>
                <div className="grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <div className="text-blue-400 font-bold mb-1">è‡ªå·±</div>
                    <div className="text-gray-300">
                      å ´ä¸Šï¼š{parsePlayerInput(teamAInput).slice(0, 3).join(', ')}
                    </div>
                    {parsePlayerInput(teamAInput).length > 3 && (
                      <div className="text-gray-500">
                        å¾Œå‚™ï¼š{parsePlayerInput(teamAInput).slice(3).join(', ')}
                      </div>
                    )}
                  </div>
                  <div>
                    <div className="text-red-400 font-bold mb-1">å°æ‰‹</div>
                    <div className="text-gray-300">
                      å ´ä¸Šï¼š{parsePlayerInput(teamBInput).slice(0, 3).join(', ')}
                    </div>
                    {parsePlayerInput(teamBInput).length > 3 && (
                      <div className="text-gray-500">
                        å¾Œå‚™ï¼š{parsePlayerInput(teamBInput).slice(3).join(', ')}
                      </div>
                    )}
                  </div>
                </div>
              </div>

              <div className="flex gap-3">
                <button
                  onClick={() => { setSetupStep(1); setSetupError(null); }}
                  className="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 rounded-xl transition-all"
                >
                  è¿”å›ä¿®æ”¹
                </button>
                <button
                  onClick={startMatch}
                  disabled={!selectedFirstServer}
                  className={`flex-1 font-bold py-4 rounded-xl text-lg flex items-center justify-center gap-2 transition-all ${
                    selectedFirstServer 
                      ? 'bg-green-500 hover:bg-green-400 text-black' 
                      : 'bg-gray-600 text-gray-400 cursor-not-allowed'
                  }`}
                >
                  <Play size={20} /> é–‹å§‹æ¯”è³½
                </button>
              </div>
            </div>
          )}
        </div>
      </div>
    );
  }

  // --- æ¯”è³½ç•«é¢ ---

  const topTeam = isSwapped ? teamA : teamB;
  const bottomTeam = isSwapped ? teamB : teamA;
  const topTeamKey = isSwapped ? 'A' : 'B';
  const bottomTeamKey = isSwapped ? 'B' : 'A';
  const isTopServing = servingTeam === topTeamKey;
  const isBottomServing = servingTeam === bottomTeamKey;
  const isDeuce = teamA.score >= 20 && teamB.score >= 20;

  return (
    <div className="h-screen w-full bg-gray-900 flex flex-col md:flex-row overflow-hidden font-sans">
      
      <div className="w-full md:w-1/3 bg-gray-800 text-white flex flex-col border-r border-gray-700 shadow-xl z-10">
        
        <div className="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-900">
          <div className="text-sm text-gray-400">
            Set {currentSet}
            {isDeuce && <span className="ml-2 text-yellow-400 font-bold animate-pulse">DEUCE!</span>}
          </div>
          <h1 className="text-xl font-bold text-yellow-500 flex items-center gap-2">
            <Trophy size={18}/> è¶³æ¯½è¨ˆåˆ†æ¿
          </h1>
          <button onClick={undo} className="p-2 bg-gray-700 rounded hover:bg-gray-600 disabled:opacity-30" disabled={gameHistory.length === 0} title="å¾©åŸä¸Šä¸€æ­¥">
             <Undo2 size={18} />
          </button>
        </div>

        {isDeuce && (
          <div className="bg-yellow-500 text-black text-center py-2 text-sm font-bold">
            âš¡ DEUCE æ¨¡å¼ï¼šè¼ªæµç™¼çƒç›´è‡³åˆ†å‡ºå‹è² ï¼
          </div>
        )}

        <div className="flex-1 flex flex-row items-stretch justify-center p-2 gap-2">
          
          <div 
            onClick={() => handleScore('A')}
            className={`flex-1 rounded-xl p-2 flex flex-col items-center justify-center cursor-pointer transition-all active:scale-95
              ${teamA.color} bg-opacity-90 hover:bg-opacity-100 border-4 ${servingTeam === 'A' ? 'border-yellow-400' : 'border-transparent'}`}
          >
            <div className="text-center mb-2">
              <div className="text-xl md:text-2xl font-bold opacity-90">{teamA.name}</div>
              <div className="text-xs bg-black/20 inline-block px-2 py-0.5 rounded mt-1">å±€æ•¸: {teamA.sets}</div>
            </div>
            <div className="text-6xl md:text-8xl font-bold font-mono">{teamA.score}</div>
          </div>

          <div 
            onClick={() => handleScore('B')}
            className={`flex-1 rounded-xl p-2 flex flex-col items-center justify-center cursor-pointer transition-all active:scale-95
              ${teamB.color} bg-opacity-90 hover:bg-opacity-100 border-4 ${servingTeam === 'B' ? 'border-yellow-400' : 'border-transparent'}`}
          >
             <div className="text-center mb-2">
              <div className="text-xl md:text-2xl font-bold opacity-90">{teamB.name}</div>
              <div className="text-xs bg-black/20 inline-block px-2 py-0.5 rounded mt-1">å±€æ•¸: {teamB.sets}</div>
            </div>
            <div className="text-6xl md:text-8xl font-bold font-mono">{teamB.score}</div>
          </div>

        </div>

        <div className="p-4 bg-gray-900 border-t border-gray-700 grid grid-cols-2 gap-3">
           <button 
             onClick={() => { setSubTeam('A'); setShowSubModal(true); }}
             className="flex items-center justify-center gap-2 bg-blue-900 text-blue-200 py-3 rounded-lg hover:bg-blue-800"
           >
             <Users size={18}/> è‡ªå·±æ›äºº
           </button>
           <button 
             onClick={() => { setSubTeam('B'); setShowSubModal(true); }}
             className="flex items-center justify-center gap-2 bg-red-900 text-red-200 py-3 rounded-lg hover:bg-red-800"
           >
             <Users size={18}/> å°æ‰‹æ›äºº
           </button>
           
           <button 
              onClick={handleManualSwap}
              className={`col-span-2 text-sm py-2 flex items-center justify-center gap-1 rounded transition-colors
                ${isSwapped ? 'bg-yellow-600 text-white' : 'text-gray-500 hover:text-white hover:bg-gray-700'}`}
           >
             <RotateCcw size={14} /> 
             {isSwapped ? 'ğŸ”„ å·²æ›å ´ - é»æ“Šæ›å›' : 'æ‰‹å‹•äº¤æ›å ´åœ°'}
           </button>
        </div>
      </div>

      {/* æ ¸å¿ƒè®Šæ›´ï¼šåœ¨è¡Œå‹•è£ç½®ä¸Šçš„çƒå ´è¦–åœ–åŠ å…¥ overflow-y-auto */}
      <div className="flex-1 relative flex flex-col h-[60vh] md:h-full bg-emerald-900 overflow-y-auto">
        
        {swapMessage && (
          <div className="absolute top-4 left-1/2 -translate-x-1/2 z-30 bg-yellow-500 text-black px-6 py-3 rounded-full font-bold text-lg shadow-lg animate-bounce">
            {swapMessage}
          </div>
        )}

        {matchOver && (
          <div className="absolute inset-0 z-20 bg-black/80 flex flex-col items-center justify-center text-white p-8 text-center backdrop-blur-sm">
            <Trophy size={64} className="text-yellow-400 mb-4 animate-bounce"/>
            <h2 className="text-4xl font-bold mb-2">æ¯”è³½çµæŸ!</h2>
            <p className="text-2xl mb-8">
               ç²å‹è€…: <span className="text-yellow-400">{teamA.sets > teamB.sets ? teamA.name : teamB.name}</span>
            </p>
            <button 
              onClick={() => window.location.reload()}
              className="bg-white text-black px-6 py-3 rounded-full font-bold hover:bg-gray-200 transition-colors"
            >
              é–‹å§‹æ–°æ¯”è³½
            </button>
          </div>
        )}

        <div className="absolute top-1/2 left-0 w-full h-1 bg-white/50 z-10 flex items-center justify-center">
            <div className="bg-white/80 px-4 py-1 rounded-full text-black text-xs font-bold shadow-sm">NET (ç¶²)</div>
        </div>

        <div className="flex-1 flex flex-col w-full h-full max-w-2xl mx-auto shadow-2xl">
          <HalfCourt team={topTeam} isTop={true} isServingTeam={isTopServing} />
          <HalfCourt team={bottomTeam} isTop={false} isServingTeam={isBottomServing} />
        </div>
      </div>

      <SubstitutionModal />
    </div>
  );
};

export default TakrawApp;
